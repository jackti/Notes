
# æ³¨æ„åŠ›æœºåˆ¶

æ³¨æ„åŠ›æ˜¯ä¸€ç§äººç±»ä¸å¯æˆ–ç¼ºçš„å¤æ‚è®¤çŸ¥èƒ½åŠ›ï¼ŒæŒ‡äººå¯ä»¥åœ¨å…³æ³¨ä¸€äº›ä¿¡æ¯çš„åŒæ—¶å¿½ç•¥å¦ä¸€äº›ä¿¡æ¯çš„é€‰æ‹©èƒ½åŠ›ï¼Œæ³¨æ„åŠ›ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ï¼š

ï¼ˆ1ï¼‰è‡ªä¸Šè€Œä¸‹çš„æœ‰æ„è¯†çš„æ³¨æ„åŠ›ï¼Œç§°ä¸ºèšç„¦å¼æ³¨æ„åŠ›(`Focus Attention`)ï¼Œèšç„¦å¼æ³¨æ„åŠ›æ˜¯æŒ‡æœ‰é¢„å®šç›®çš„ã€ä¾èµ–ä»»åŠ¡çš„ï¼Œä¸»åŠ¨æœ‰æ„è¯†å¾—èšç„¦äºæŸä¸€å¯¹è±¡çš„æ³¨æ„åŠ›ï¼Œåé¢æåˆ°çš„æ³¨æ„åŠ›é€šå¸¸éƒ½æ˜¯æŒ‡è‡ªä¸Šè€Œä¸‹çš„èšç„¦å¼æ³¨æ„åŠ›ã€‚

ï¼ˆ2ï¼‰è‡ªä¸Šä¸‹è€Œä¸Šçš„æ— æ„è¯†å¾—æ³¨æ„åŠ›ï¼Œç§°ä¸ºåŸºäºæ˜¾è‘—æ€§çš„æ³¨æ„åŠ›(`Saliency-Based Attention`)ï¼ŒåŸºäºæ˜¾è‘—æ€§çš„æ³¨æ„åŠ›æ˜¯ç”±å¤–ç•Œåˆºæ¿€é©±åŠ¨çš„æ³¨æ„ï¼Œä¸éœ€è¦ä¸»åŠ¨å¹²é¢„ï¼Œä¹Ÿå’Œä»»åŠ¡æ— å…³ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡çš„åˆºæ¿€ä¿¡æ¯ä¸åŒäºå…¶å‘¨å›´ä¿¡æ¯ï¼Œä¸€ç§æ— æ„è¯†çš„"èµ¢è€…é€šåƒ"(`Winner-Take-All`)æˆ–è€…é—¨æ§(`Gating`)æœºåˆ¶å°±å¯ä»¥æŠŠæ³¨æ„åŠ›è½¬å‘è¿™ä¸ªå¯¹è±¡ã€‚ä¸ç®¡è¿™äº›æ³¨æ„åŠ›æ˜¯æœ‰æ„è¿˜æ˜¯æ— æ„ï¼Œå¤§éƒ¨åˆ†çš„äººè„‘æ´»åŠ¨éƒ½éœ€è¦ä¾èµ–æ³¨æ„åŠ›ï¼Œæ¯”å¦‚è®°å¿†ä¿¡æ¯ã€é˜…è¯»æˆ–æ€è€ƒç­‰ã€‚

åœ¨ç›®å‰çš„ç¥ç»ç½‘ç»œæ¨¡å‹ä¸­ï¼Œå¯ä»¥å°†æœ€å¤§æ±‡èš(`Max Pooling`)ã€é—¨æ§(`Gating`)æœºåˆ¶è¿‘ä¼¼åœ°çœ‹ä½œè‡ªä¸‹è€Œä¸Šçš„åŸºäºæ˜¾è‘—æ€§çš„æ³¨æ„åŠ›æœºåˆ¶ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œè‡ª ä¸Šè€Œä¸‹çš„èšç„¦å¼æ³¨æ„åŠ›ä¹Ÿæ˜¯ä¸€ç§æœ‰æ•ˆçš„ä¿¡æ¯é€‰æ‹©æ–¹å¼.ä»¥é˜…è¯»ç†è§£ä»»åŠ¡ä¸ºä¾‹ï¼Œç»™ å®šä¸€ç¯‡å¾ˆé•¿çš„æ–‡ç« ï¼Œç„¶åå°±æ­¤æ–‡ç« çš„å†…å®¹è¿›è¡Œæé—®.æå‡ºçš„é—®é¢˜åªå’Œæ®µè½ä¸­çš„ä¸€ ä¸¤ä¸ªå¥å­ç›¸å…³ï¼Œå…¶ä½™éƒ¨åˆ†éƒ½æ˜¯æ— å…³çš„.ä¸ºäº†å‡å°ç¥ç»ç½‘ç»œçš„è®¡ç®—è´Ÿæ‹…ï¼Œåªéœ€è¦æŠŠ ç›¸å…³çš„ç‰‡æ®µæŒ‘é€‰å‡ºæ¥è®©åç»­çš„ç¥ç»ç½‘ç»œæ¥å¤„ç†ï¼Œè€Œä¸éœ€è¦æŠŠæ‰€æœ‰æ–‡ç« å†…å®¹éƒ½è¾“
å…¥ç»™ç¥ç»ç½‘ç»œ.

> èšç„¦å¼æ³¨æ„åŠ›ä¸€èˆ¬ä¼šéšç€ç¯å¢ƒã€æƒ…æ™¯æˆ–ä»»åŠ¡çš„ä¸åŒè€Œé€‰æ‹©ä¸åŒçš„ä¿¡æ¯.æ¯”å¦‚å½“è¦ä»äººç¾¤ä¸­å¯»æ‰¾æŸä¸ªäººæ—¶ï¼Œæˆ‘ä»¬ä¼šä¸“æ³¨äºæ¯ä¸ªäººçš„è„¸éƒ¨;è€Œå½“è¦ç»Ÿè®¡äººç¾¤çš„äººæ•°æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸“æ³¨äºæ¯ä¸ªäººçš„è½®å»“.

åœ¨è®¡ç®—èƒ½åŠ›æœ‰é™çš„æƒ…å†µä¸‹ï¼Œæ³¨æ„åŠ›æœºåˆ¶ä½œä¸ºä¸€ç§èµ„æºåˆ†é…æ–¹æ¡ˆï¼Œå°†æœ‰é™çš„è®¡ç®—èµ„æºç”¨æ¥å¤„ç†æ›´é‡è¦çš„ä¿¡æ¯ï¼Œæ˜¯è§£å†³ä¿¡æ¯è¶…è½½é—®é¢˜ä¸»è¦æ‰‹æ®µã€‚ç”¨$\boldsymbol{X}=[\boldsymbol{x}_1,\cdots,\boldsymbol{x}_N]\in \mathbb{R}^{D\times N}$è¡¨ç¤º$N$ç»„è¾“å…¥ä¿¡æ¯ï¼Œå…¶ä¸­$D$ç»´å‘é‡$\boldsymbol{x}_n\in\mathbb{R}^D,n\in [1,\cdots,N]$è¡¨ç¤ºä¸€ç»„è¾“å…¥ä¿¡æ¯ï¼Œä¸ºäº†èŠ‚çœè®¡ç®—èµ„æºï¼Œä¸éœ€è¦å°†æ‰€æœ‰ä¿¡æ¯éƒ½è¾“å…¥ç¥ç»ç½‘ç»œï¼Œåªéœ€è¦ä»$\boldsymbol{X}$ä¸­é€‰æ‹©ä¸€äº›å’Œä»»åŠ¡ç›¸å…³çš„ä¿¡æ¯ã€‚æ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—å¯ä»¥åˆ†ä¸ºä¸¤æ­¥ï¼š
1. åœ¨æ‰€æœ‰è¾“å…¥ä¿¡æ¯ä¸Šè®¡ç®—æ³¨æ„åŠ›åˆ†å¸ƒ
2. æ ¹æ®æ³¨æ„åŠ›åˆ†å¸ƒæ¥è®¡ç®—è¾“å…¥ä¿¡æ¯çš„åŠ æƒå¹³å‡

## æ³¨æ„åŠ›åˆ†å¸ƒ

ä¸ºäº†ä»$N$ä¸ªè¾“å…¥å‘é‡$[\boldsymbol{x}_1,\cdots,\boldsymbol{x}_N]$ä¸­é€‰æ‹©å‡ºå’ŒæŸä¸ªç‰¹å®šä»»åŠ¡ç›¸å…³çš„ä¿¡æ¯ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªå’Œä»»åŠ¡ç›¸å…³çš„è¡¨ç¤ºï¼Œç§°ä¸ºæŸ¥è¯¢å‘é‡(`Query Vector`)å¹¶é€šè¿‡ä¸€ä¸ªæ‰“åˆ†å‡½æ•°æ¥è®¡ç®—æ¯ä¸ªè¾“å…¥å‘é‡å’ŒæŸ¥è¯¢å‘é‡ä¹‹é—´çš„ç›¸å…³æ€§.

ç»™å®šä¸€ä¸ªå’Œä»»åŠ¡ç›¸å…³çš„æŸ¥è¯¢å‘é‡$\boldsymbol{q}$ï¼Œç”¨æ³¨æ„åŠ›å˜é‡$z\in [1,\cdots,N]$æ¥è¡¨ç¤ºè¢«é€‰æ‹©ä¿¡æ¯çš„ç´¢å¼•ä½ç½®ï¼Œå³$z=n$è¡¨ç¤ºé€‰æ‹©äº†ç¬¬$n$ä¸ªè¾“å…¥å‘é‡ï¼Œä¸ºäº†è®¡ç®—æ–¹ä¾¿ï¼Œé‡‡ç”¨ä¸€ç§"è½¯æ€§"çš„ä¿¡æ¯é€‰æ‹©æœºåˆ¶ã€‚é¦–å…ˆè®¡ç®—åœ¨ç»™å®š$\boldsymbol{q}$å’Œ$\boldsymbol{X}$ä¸‹ï¼Œé€‰æ‹©ç¬¬$i$ä¸ªè¾“å…¥å‘é‡çš„æ¦‚ç‡$\alpha_n$
$$
\begin{aligned}
\alpha_n 
&= p(z=n|\boldsymbol{X},\boldsymbol{q}) \\
&=\operatorname{softmax}(s(\boldsymbol{x}_n,\boldsymbol{q}))\\
&=\frac{\operatorname{exp}(s(\boldsymbol{x}_n,\boldsymbol{q}))}
{\sum_{j=1}^N \operatorname{exp}(s(\boldsymbol{x}_j,\boldsymbol{q})) }    
\end{aligned}
$$
å…¶ä¸­$\alpha_n$ç§°ä¸ºæ³¨æ„åŠ›åˆ†å¸ƒï¼Œ$s(\boldsymbol{x},\boldsymbol{q})$ä¸ºæ³¨æ„åŠ›æ‰“åˆ†å‡½æ•°ï¼Œå…¶ä¸­å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡ ç§æ–¹å¼æ¥è®¡ç®—

| æ¨¡å‹      | å…¬å¼ |
| --------- | ---- |
| åŠ æƒæ¨¡å‹ |$s(\boldsymbol{x},\boldsymbol{q})=\boldsymbol{v}^\top\operatorname{tanh(\boldsymbol{W}\boldsymbol{x}+\boldsymbol{U}\boldsymbol{q})}$      |
| ç‚¹ç§¯æ¨¡å‹ | $s(\boldsymbol{x},\boldsymbol{q})=\boldsymbol{x}^\top \boldsymbol{q}$ |
| ç¼©æ”¾ç‚¹æ¨¡å‹ | $s(\boldsymbol{x},\boldsymbol{q})=\frac{\boldsymbol{x}^\top \boldsymbol{q}}{\sqrt{D}}$ |
| åŒçº¿æ€§æ¨¡å‹ | $s(\boldsymbol{x},\boldsymbol{q})=\boldsymbol{x}^\top \boldsymbol{W} \boldsymbol{q}$ |

å…¶ä¸­$\boldsymbol{W},\boldsymbol{U},\boldsymbol{v}$ä¸ºå¯å­¦ä¹ çš„å‚æ•°ï¼Œ$D$ä¸ºè¾“å…¥å‘é‡çš„ç»´åº¦.

ç†è®ºä¸Šï¼ŒåŠ æ€§æ¨¡å‹å’Œç‚¹ç§¯æ¨¡å‹çš„å¤æ‚åº¦å·®ä¸å¤šï¼Œä½†æ˜¯ç‚¹ç§¯æ¨¡å‹åœ¨å®ç°ä¸Šå¯ä»¥æ›´å¥½åœ°åˆ©ç”¨çŸ©é˜µä¹˜ç§¯ï¼Œä»è€Œè®¡ç®—æ•ˆç‡æ›´é«˜.

å½“è¾“å…¥å‘é‡çš„ç»´åº¦$D$æ¯”è¾ƒé«˜æ—¶ï¼Œç‚¹ç§¯æ¨¡å‹çš„å€¼é€šå¸¸æœ‰æ¯”è¾ƒå¤§çš„æ–¹å·®ï¼Œä»è€Œå¯¼è‡´$\operatorname{Softmax}$å‡½æ•°çš„æ¢¯åº¦ä¼šæ¯”è¾ƒå°ã€‚å› æ­¤ï¼Œç¼©æ”¾ç‚¹ç§¯æ¨¡å‹å¯ä»¥æ¯”è¾ƒå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

åŒçº¿æ€§æ¨¡å‹æ˜¯ä¸€ç§æ³›åŒ–çš„ç‚¹ç§¯æ¨¡å‹ï¼Œå½“$\boldsymbol{W}=\boldsymbol{U}^\top \boldsymbol{U}$åŒçº¿æ€§æ¨¡å‹å¯ä»¥å†™ä¸º$s(\boldsymbol{x},\boldsymbol{q})=\boldsymbol{x}\boldsymbol{U}^\top \boldsymbol{V}\boldsymbol{q}=(\boldsymbol{U}\boldsymbol{x})^\top (\boldsymbol{V}\boldsymbol{q})$å³åˆ†åˆ«å¯¹$\boldsymbol{x}$å’Œ$\boldsymbol{q}$è¿›è¡Œçº¿æ€§å˜æ¢åè®¡ç®—ç‚¹ç§¯ï¼Œç›¸æ¯”ç‚¹ç§¯æ¨¡å‹ï¼ŒåŒçº¿æ€§æ¨¡å‹åœ¨è®¡ç®—ç›¸ä¼¼åº¦æ—¶å¼•å…¥äº†éå¯¹ç§°æ€§.



## åŠ æƒå¹³å‡

æ³¨æ„åŠ›åˆ†å¸ƒ$\alpha_n$å¯ä»¥è§£é‡Šä¸ºåœ¨ç»™å®šä»»åŠ¡ç›¸å…³çš„æŸ¥è¯¢$\boldsymbol{q}$æ—¶ï¼Œç¬¬$n$ä¸ªè¾“å…¥å‘é‡å—å…³æ³¨çš„ç¨‹åº¦ï¼Œå¯ä»¥é‡‡ç”¨ä¸€ç§"è½¯æ€§"çš„ä¿¡æ¯é€‰æ‹©æœºåˆ¶å¯¹è¾“å…¥ä¿¡æ¯è¿›è¡Œæ±‡æ€»ï¼Œå³
$$
\begin{aligned}
\operatorname{att}(\boldsymbol{X},\boldsymbol{q})
&=\sum_{n=1}^N \alpha_n \boldsymbol{x}_n\\
&=\mathbb{E}_{\boldsymbol{z} \sim p(\boldsymbol{z}| \boldsymbol{X},\boldsymbol{q})}[\boldsymbol{x}_z]
\end{aligned}
$$

æ³¨æ„åŠ›æœºåˆ¶å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä½†æ›´å¤šåœ°ç”¨ä½œç¥ç»ç½‘ç»œä¸­çš„ä¸€ä¸ªç»„ä»¶.



# æ³¨æ„åŠ›æœºåˆ¶çš„å˜ä½“

é™¤äº†ä¸Šé¢ä»‹ç»çš„åŸºæœ¬æ¨¡å¼å¤–ï¼Œæ³¨æ„åŠ›æœºåˆ¶è¿˜å­˜åœ¨ä¸€äº›å˜åŒ–çš„æ¨¡å‹ã€‚

## ç¡¬æ€§æ³¨æ„åŠ›
å‰é¢çš„æ³¨æ„åŠ›æ˜¯è½¯æ€§æ³¨æ„åŠ›ï¼Œå…¶é€‰æ‹©åœ°ä¿¡æ¯æ˜¯æ‰€æœ‰è¾“å…¥å‘é‡åœ¨æ³¨æ„åŠ›åˆ†å¸ƒä¸‹çš„æœŸæœ›ã€‚æ­¤å¤–è¿˜æœ‰ä¸€ç§æ³¨æ„åŠ›åªå…³æ³¨æŸä¸€ä¸ªè¾“å…¥å‘é‡ï¼Œå«åšç¡¬æ³¨æ„åŠ›æœºåˆ¶ã€‚ç¡¬æ³¨æ„åŠ›æœºåˆ¶æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š
ï¼ˆ1ï¼‰ä¸€ç§æ˜¯é€‰å–æœ€é«˜æ¦‚ç‡çš„ä¸€ä¸ªè¾“å…¥å‘é‡ï¼Œå³
$$
\operatorname{att}(\boldsymbol{X},\boldsymbol{q})
=\boldsymbol{x}_{\hat{n}}
$$
å…¶ä¸­$\hat{n}$ä¸ºæ¦‚ç‡æœ€å¤§çš„è¾“å…¥å‘é‡ä¸‹æ ‡ï¼Œå³$\hat{n}=\underset{n=1}{\arg \max } \alpha_{n}$

ï¼ˆ2ï¼‰å¦ä¸€ç§ç¡¬æ€§æ³¨æ„åŠ›å¯ä»¥é€šè¿‡åœ¨æ³¨æ„åŠ›åˆ†å¸ƒä¸Šéšæœºé‡‡æ ·çš„æ–¹å¼å®ç°ã€‚

ç¡¬æ€§æ³¨æ„åŠ›çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯åŸºäºæœ€å¤§é‡‡æ ·æˆ–éšæœºé‡‡æ ·çš„æ–¹å¼æ¥é€‰æ‹©ä¿¡æ¯ï¼Œä½¿å¾—æœ€ç»ˆçš„æŸå¤±å‡½æ•°ä¸æ³¨æ„åŠ›åˆ†å¸ƒä¹‹é—´çš„å‡½æ•°å…³ç³»ä¸å¯å¯¼ï¼Œæ— æ³•ä½¿ç”¨åå‘ä¼ æ’­ç®— æ³•è¿›è¡Œè®­ç»ƒ.å› æ­¤ï¼Œç¡¬æ€§æ³¨æ„åŠ›é€šå¸¸éœ€è¦ä½¿ç”¨å¼ºåŒ–å­¦ä¹ æ¥è¿›è¡Œè®­ç»ƒ.ä¸ºäº†ä½¿ç”¨åå‘ä¼ æ’­ç®—æ³•ï¼Œä¸€èˆ¬ä½¿ç”¨è½¯æ€§æ³¨æ„åŠ›æ¥ä»£æ›¿ç¡¬æ€§æ³¨æ„åŠ›.

## å¥å€¼å¯¹æ³¨æ„åŠ›
æ›´ä¸€èˆ¬åœ°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨é”®å€¼å¯¹(`key-value pair`)æ ¼å¼æ¥è¡¨ç¤ºè¾“å…¥ä¿¡æ¯ï¼Œå…¶ä¸­â€œé”®â€ç”¨æ¥è®¡ç®—æ³¨æ„åŠ›åˆ†å¸ƒ$\alpha_n$ï¼Œâ€œå€¼â€ç”¨æ¥è®¡ç®—èšåˆä¿¡æ¯.ç”¨$(\boldsymbol{K},\boldsymbol{V}) = [(\boldsymbol{k}_1,\boldsymbol{v}_1),â‹¯,(\boldsymbol{k}_N,\boldsymbol{v}_N)]$è¡¨ç¤º$N$ç»„è¾“å…¥ä¿¡æ¯ï¼Œç»™å®šä»»åŠ¡ç›¸å…³çš„æŸ¥è¯¢å‘é‡$\boldsymbol{q}$æ—¶ï¼Œæ³¨æ„åŠ›å‡½æ•°ä¸º
$$
\begin{aligned}
\operatorname{att}((\boldsymbol{K}, \boldsymbol{V}), \boldsymbol{q}) &=\sum_{n=1}^{N} \alpha_{n} \boldsymbol{v}_{n} \\
&=\sum_{n=1}^{N} \frac{\exp \left(s\left(\boldsymbol{k}_{n}, \boldsymbol{q}\right)\right)}{\sum_{j} \exp \left(s\left(\boldsymbol{k}_{j}, \boldsymbol{q}\right)\right)} \boldsymbol{v}_{n},
\end{aligned}
$$
å…¶ä¸­$s(\boldsymbol{k}_n,\boldsymbol{q})$ä¸ºæ‰“åˆ†å‡½æ•°ã€‚å½“$\boldsymbol{K}=\boldsymbol{V}$æ—¶ï¼Œé”®å€¼å¯¹æ¨¡å¼å°±ç­‰ä»·äºæ™®é€šçš„æ³¨æ„åŠ›æœºåˆ¶.

<img src="assets/image-20210123201346323.png" alt="image-20210123201346323" style="zoom:30%;" />





<img src="assets/image-20210626190228372.png" alt="image-20210626190228372" style="zoom:50%;" />





## å¤šå¤´æ³¨æ„åŠ›

å¤šå¤´æ³¨æ„åŠ›(`Multi-Head Attention`)æ˜¯åˆ©ç”¨å¤šä¸ªæŸ¥è¯¢$\boldsymbol{Q}=[\boldsymbol{q}_1,\cdots,\boldsymbol{q}_M]$æ¥å¹¶è¡Œåœ°è¾“ä»è¾“å…¥ä¿¡æ¯ä¸­é€‰å–å¤šç»„ä¿¡æ¯ï¼Œæ¯ä¸ªæ³¨æ„åŠ›å…³æ³¨è¾“å…¥ä¿¡æ¯çš„ä¸åŒéƒ¨åˆ†
$$
\operatorname{att}((\boldsymbol{K}, \boldsymbol{V}), \boldsymbol{Q})=\operatorname{att}\left((\boldsymbol{K}, \boldsymbol{V}), \boldsymbol{q}_{1}\right) \oplus \cdots \oplus \operatorname{att}\left((\boldsymbol{K}, \boldsymbol{V}), \boldsymbol{q}_{M}\right)
$$
å…¶ä¸­$\oplus$è¡¨ç¤ºå‘é‡æ‹¼æ¥.





# è‡ªæ³¨æ„åŠ›æ¨¡å‹
å½“ä½¿ç”¨ç¥ç»ç½‘ç»œæ¥å¤„ç†ä¸€ä¸ªå˜é•¿çš„å‘é‡åºåˆ—æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥ä½¿ç”¨å·ç§¯ç½‘ç»œæˆ–å¾ªç¯ç½‘ç»œè¿›è¡Œç¼–ç æ¥å¾—åˆ°ä¸€ä¸ªç›¸åŒé•¿åº¦çš„è¾“å‡ºå‘é‡åºåˆ—ï¼Œå¦‚å›¾æ‰€ç¤º

<img src="assets/image-20210125231949944.png" alt="image-20210125231949944" style="zoom:30%;" />

åŸºäºå·ç§¯æˆ–å¾ªç¯ç½‘ç»œçš„åºåˆ—ç¼–ç éƒ½æ˜¯ä¸€ç§å±€éƒ¨çš„ç¼–ç æ–¹å¼ï¼Œåªå»ºæ¨¡äº†è¾“å…¥ä¿¡æ¯çš„å±€éƒ¨ä¾èµ–å…³ç³».è™½ç„¶å¾ªç¯ç½‘ç»œç†è®ºä¸Šå¯ä»¥å»ºç«‹é•¿è·ç¦»ä¾èµ–å…³ç³»ï¼Œä½†æ˜¯ç”±äº ä¿¡æ¯ä¼ é€’çš„å®¹é‡ä»¥åŠæ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œå®é™…ä¸Šä¹Ÿåªèƒ½å»ºç«‹çŸ­è·ç¦»ä¾èµ–å…³ç³»ã€‚

å¦‚æœè¦å»ºç«‹è¾“å…¥åºåˆ—ä¹‹é—´çš„é•¿è·ç¦»ä¾èµ–å…³ç³»ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸¤ç§æ–¹æ³•:(1)ä¸€ç§æ–¹æ³•æ˜¯å¢åŠ ç½‘ç»œçš„å±‚æ•°ï¼Œé€šè¿‡ä¸€ä¸ªæ·±å±‚ç½‘ç»œæ¥è·å–è¿œè·ç¦»çš„ä¿¡æ¯äº¤äº’;(2)å¦ä¸€ç§æ–¹ æ³•æ˜¯ä½¿ç”¨å…¨è¿æ¥ç½‘ç»œ.å…¨è¿æ¥ç½‘ç»œæ˜¯ä¸€ç§éå¸¸ç›´æ¥çš„å»ºæ¨¡è¿œè·ç¦»ä¾èµ–çš„æ¨¡å‹ï¼Œä½†æ˜¯æ— æ³•å¤„ç†å˜é•¿çš„è¾“å…¥åºåˆ—.ä¸åŒçš„è¾“å…¥é•¿åº¦ï¼Œå…¶è¿æ¥æƒé‡çš„å¤§å°ä¹Ÿæ˜¯ä¸åŒçš„. è¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨æ³¨æ„åŠ›æœºåˆ¶æ¥â€œåŠ¨æ€â€åœ°ç”Ÿæˆä¸åŒè¿æ¥çš„æƒé‡ï¼Œè¿™å°±æ˜¯è‡ªæ³¨æ„åŠ›æ¨¡å‹(`Self-Attention Model`)

ä¸ºäº†æé«˜æ¨¡å‹èƒ½åŠ›ï¼Œè‡ªæ³¨æ„åŠ›æ¨¡å‹ç»å¸¸é‡‡ç”¨æŸ¥è¯¢-é”®-å€¼(`Query-Key-Valueï¼Œ QKV`)æ¨¡å¼ï¼Œå…¶è®¡ç®—è¿‡ç¨‹å¦‚å›¾8.4æ‰€ç¤ºï¼Œå…¶ä¸­çº¢è‰²å­—æ¯è¡¨ç¤ºçŸ©é˜µçš„ç»´åº¦.

<img src="assets/image-20210125233301077.png" alt="image-20210125233301077" style="zoom:30%;" />

å‡è®¾è¾“å…¥åºåˆ—ä¸º$\boldsymbol{X}= [\boldsymbol{x}_1,â‹¯,\boldsymbol{x}_N] âˆˆ \mathbb{R}^{D_x \times N}$ï¼Œè¾“å‡ºåºåˆ—ä¸º$\boldsymbol{H} = [\boldsymbol{h}_1,â‹¯,\boldsymbol{h}_ğ‘] âˆˆ \mathbb{R}^{ğ·_v \times ğ‘}$ ï¼Œè‡ªæ³¨æ„åŠ›æ¨¡å‹çš„å…·ä½“è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹:

(1)å¯¹äºæ¯ä¸ªè¾“å…¥$\boldsymbol{x}_i$ï¼Œæˆ‘ä»¬é¦–å…ˆå°†å…¶çº¿æ€§æ˜ å°„åˆ°ä¸‰ä¸ªä¸åŒçš„ç©ºé—´ï¼Œå¾—åˆ°æŸ¥è¯¢å‘é‡$\boldsymbol{q}_i \in \mathbb{R}^{D_k}$ ã€é”®å‘é‡$\boldsymbol{k}_i \in \mathbb{R}^{D_k}$ å’Œå€¼å‘é‡$\boldsymbol{v}_i \in \mathbb{R}^{D_v}$

å¯¹äºæ•´ä¸ªè¾“å…¥åºåˆ—$\boldsymbol{X}$ï¼Œçº¿æ€§æ˜ å°„è¿‡ç¨‹å¯ä»¥ç®€å†™ä¸º
$$
\begin{array}{l}
\boldsymbol{Q}=\boldsymbol{W}_{q} \boldsymbol{X} \in \mathbb{R}^{D_{k} \times N} \\
\boldsymbol{K}=\boldsymbol{W}_{k} \boldsymbol{X} \in \mathbb{R}^{D_{k} \times N} \\
\boldsymbol{V}=\boldsymbol{W}_{v} \boldsymbol{X} \in \mathbb{R}^{D_{v} \times N}
\end{array}
$$
å…¶ä¸­ $\boldsymbol{W}_{q} \in \mathbb{R}^{D_{k} \times D_{x}}, \boldsymbol{W}_{k} \in \mathbb{R}^{D_{k} \times D_{x}}, \boldsymbol{W}_{v} \in \mathbb{R}^{D_{v} \times D_{x}}$ fåˆ†åˆ«ä¸ºçº¿æ€§æ˜ å°„çš„å‚æ•°çŸ©é˜µï¼Œ$\boldsymbol{Q}=\left[\boldsymbol{q}_{1}, \cdots, \boldsymbol{q}_{N}\right], \boldsymbol{K}=\left[\boldsymbol{k}_{1}, \cdots, \boldsymbol{k}_{N}\right], \boldsymbol{V}=\left[\boldsymbol{v}_{1}, \cdots, \boldsymbol{v}_{N}\right]$ åˆ†åˆ«æ˜¯ç”±æŸ¥è¯¢å‘é‡ã€é”®å‘é‡å’Œå€¼å‘é‡æ„æˆçš„çŸ©é˜µ.

(2)å¯¹äºæ¯ä¸€ä¸ªæŸ¥è¯¢å‘é‡$\boldsymbol{q}_n \in \boldsymbol{Q}$ï¼Œåˆ©ç”¨é”®å€¼å¯¹æ³¨æ„åŠ›æœºåˆ¶ï¼Œå¯ä»¥å¾—åˆ°è¾“å‡ºå‘é‡$\boldsymbol{h}_n$ 
$$
\begin{aligned}
\boldsymbol{h}_{n}
&=\operatorname{att}\left((\boldsymbol{K}, \boldsymbol{V}), \boldsymbol{q}_{n}\right)\\
&=\sum_{j=1}^{N} \alpha_{n j} \boldsymbol{v}_{j} \\
&=\sum_{j=1}^{N} \operatorname{softmax}\left(s\left(\boldsymbol{k}_{j}, \boldsymbol{q}_{n}\right)\right) \boldsymbol{v}_{j}
\end{aligned}
$$
å…¶ä¸­$n,j\in [1,\cdots,N]$ä¸ºè¾“å‡ºå’Œè¾“å…¥å‘é‡åºåˆ—çš„ä½ç½®ï¼Œ$\alpha_{nj}$è¡¨ç¤ºç¬¬$n$ä¸ªè¾“å‡ºå…³æ³¨åˆ°ç¬¬$j$ä¸ªè¾“å…¥çš„æƒé‡.
å¦‚æœä½¿ç”¨ç¼©æ”¾ç‚¹ç§¯æ¥ä½œä¸ºæ³¨æ„åŠ›æ‰“åˆ†å‡½æ•°ï¼Œè¾“å‡ºå‘é‡åºåˆ—å¯ä»¥ç®€å†™ä¸º
$$
\boldsymbol{H}=\boldsymbol{V} \operatorname{softmax}\left(\frac{\boldsymbol{K}^{\top} \boldsymbol{Q}}{\sqrt{D_{k}}}\right)
$$
å…¶ä¸­$\operatorname{softmax}(\cdot)$ä¸ºæŒ‰åˆ—è¿›è¡Œå½’ä¸€åŒ–çš„å‡½æ•°ã€‚ä¸‹å›¾ä¸­ç»™å‡ºå…¨è¿æ¥æ¨¡å‹å’Œè‡ªæ³¨æ„åŠ›æ¨¡å‹çš„å¯¹æ¯”ï¼Œå…¶ä¸­å®çº¿è¡¨ç¤ºå¯å­¦ä¹ çš„æƒé‡ï¼Œè™šçº¿è¡¨ç¤ºåŠ¨æ€ç”Ÿæˆçš„æƒé‡.ç”±äºè‡ªæ³¨æ„åŠ›æ¨¡å‹çš„æƒé‡æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œå› æ­¤å¯ä»¥å¤„ç†å˜é•¿çš„ä¿¡æ¯åºåˆ—.

<img src="assets/image-20210126000605275.png" alt="image-20210126000605275" style="zoom:40%;" />

